---
title: "Data import and cleaning from .xlsx files sent by the Technion"
author: "Amir Levine"
date: "2018-10-29"
output: md_document
---

## Data Cleaning

Load tidyverse.
```{r}
if (!require(tidyverse)) {install.packages("tidyverse"); library(tidyverse)}
```

Import the gene expression data sent by Efrat from the Technion.
Specifiy how to treat NA values.
Specify the columns' data-types, as by default in loads all as characters.
```{r}
AM <- readxl::read_excel(
  "raw/2018-10-25-Results_files/Final_results_AM140_treated_vs_untreated_.xlsx", 
  col_names = TRUE, 
  col_types = c(rep("text",4),rep("numeric",5),rep("text",4)), 
  na = 'NA')
CL <- readxl::read_excel(
  "raw/2018-10-25-Results_files/Final_results_CL2006_treated_vs_untreated_.xlsx",
  col_names = TRUE, 
  col_types = c(rep("text",4),rep("numeric",5),rep("text",4)), 
  na = 'NA')
N2 <- readxl::read_excel(
  "raw/2018-10-25-Results_files/Final_results_N2_treated_vs_untreated.xlsx",
  col_names = TRUE, 
  col_types = c(rep("text",4),rep("numeric",5),rep("text",4)), 
  na = 'NA')
```

Merge the three data-frames to one gene expression (ge) data-frame.
Remove unnecessary columnns.
Focus on genes that underwent the multiple comparisons test (*Tested*)
Sort the dataframe by 
```{r}
ge <- bind_rows(list(N2 = N2,AM140 = AM, CL2006 = CL), .id = 'strain') %>%
  dplyr::filter(`flag Treated vs untreated` == "Tested") %>%
  dplyr::select(strain,
                `Gene ID`,
                `gene name`,
                baseMean,
                `log2FoldChange Treated vs untreated`,
                `padj Treated vs untreated`) %>%
  arrange(`padj Treated vs untreated`) %>%
  group_by(strain)
```

Remove individual strains data-frames.
```{r}
rm(list = c("AM","CL","N2"))
```

## Venn Diagram
Load packages
```{r}
if (!require(VennDiagram)) {install.packages("VennDiagram"); library(VennDiagram)}
if (!require(viridis)) {install.packages("viridis"); library(viridis)}
```

Obtain gene lists of upregulated genes (*p*-value < 0.1), for each strain.
```{r}
AM <- ge %>% 
  filter(strain == "AM140",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` > 0) %>%
  pull(`Gene ID`)

CL <- ge %>% 
  filter(strain == "CL2006",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` > 0) %>%
  pull(`Gene ID`)

N2<- ge %>% 
  filter(strain == "N2",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` > 0) %>%
  pull(`Gene ID`)
```

Visualize up- and down-regulated genes in the three strains.
```{r}
dir.create("results", showWarnings = FALSE)
filename = "results/2018-11-04-venn_anc1_upregulated.tiff"
title = "Upregulated (p < 0.1)"

venn.diagram(
  x = list(AM, CL, N2),
  filename = filename,
  category = c("AM140","CL2006","N2"),
  resolution = 300,
  imagetype = "tiff",
  main = title,
  main.cex = 3,
  main.fontfamily = "sans",
  fill = viridis(3),
  cex = 2.5 ,# size of the areas’ labels
  fontfamily = "sans", # the fontfamily of the areas’ labels
  cat.cex = 2.5 ,#the size of the category names
  cat.pos = c(0,0,0),
  cat.dist = 0,
  cat.fontfamily = "sans"
  #print.mode = c("raw","percent")
  #sub = "p < 0.0001",
  #sub.cex = 2,
  #sub.fontfamily = "sans"
)
```

Obtain gene lists of downregulated genes (*p*-value < 0.1), for each strain.
```{r}
AM <- ge %>% 
  filter(strain == "AM140",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` < 0) %>%
  pull(`Gene ID`)

CL <- ge %>% 
  filter(strain == "CL2006",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` < 0) %>%
  pull(`Gene ID`)

N2<- ge %>% 
  filter(strain == "N2",
         `padj Treated vs untreated` < 0.1,
         `log2FoldChange Treated vs untreated` < 0) %>%
  pull(`Gene ID`)
```

Visualize up- and down-regulated genes in the three strains.
```{r}
dir.create("results", showWarnings = FALSE)
filename = "results/2018-11-04-venn_anc1_downregulated.tiff"
title = "Downregulated (p < 0.1)"

venn.diagram(
  x = list(AM, CL, N2),
  filename = filename,
  category = c("AM140","CL2006","N2"),
  resolution = 300,
  imagetype = "tiff",
  main = title,
  main.cex = 3,
  main.fontfamily = "sans",
  fill = viridis(3),
  cex = 2.5 ,# size of the areas’ labels
  fontfamily = "sans", # the fontfamily of the areas’ labels
  cat.cex = 2.5 ,#the size of the category names
  cat.pos = c(0,0,0),
  cat.dist = -0.05,
  cat.fontfamily = "sans"
)
```

Remove variables.
```{r}
rm(list = c("AM","CL","N2","filename","title"))
```



```{r}

```



```{r}
write(ge %>% filter(`padj Treated vs untreated` < 0.1) %>% pull(`Gene ID`) %>% unique(),
      file = "a.txt")
```



